<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>避難所統括本部</title>
	<link rel="stylesheet" href="CSS/style_index.css">
</head>

<body>
	<header>
		<h2>避難所統括本部</h2>
	</header>
	<main>
		<div class="outerframe">
			<div class="uppercolumn">
				<div class="upperleft">
					<p>/// ビデオ会議 ///</p>
				</div> <!-- upperleft -->
				<div class="upperright">
					<p>/// 連絡・問い合わせ ///</p>
					<ul id="outputChat"></ul>
				</div> <!-- upperright -->

			</div> <!-- /uppercolumn -->
			<div class="lowercolumn">
				<div class="lowerleft">
					<p>/// 避難者の状況 ///</p>
					<table id="hinansha">
						<thead>
							<tr>
								<th>校区</th>
								<th>世帯数</th>
								<th>人数</th>
								<th>(要配慮者)</th>
								<th>報告時間</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>中央</td>
								<td id="setaiC"></td>
								<td id="evacueesC"></td>
								<td id="welfareC"></td>
								<td id="timeC"></td>
							</tr>
							<tr>
								<td>南</td>
								<td id="setaiS"></td>
								<td id="evacueesS"></td>
								<td id="welfareS"></td>
								<td id="timeS"></td>
							</tr>
							<tr>
								<td>北</td>
								<td id="setaiN"></td>
								<td id="evacueesN"></td>
								<td id="welfareN"></td>
								<td id="timeN"></td>
							</tr>
							<tr>
								<td>合計</td>
								<td id="setaiSum"></td>
								<td id="evacueesSum"></td>
								<td id="welfareSum"></td>
								<td><span>♣ ♣ ♣</span></td>
							</tr>
						</tbody>
					</table>
				</div> <!-- lowerleft -->
				<div class="lowerright">
					<p>/// 物資の使用記録 ///</p>

					<ul id="outputBusshi ul_news"></ul>

					<div id="div_ticker4" class="tick"></div>

				</div> <!-- lowerright -->
			</div> <!-- /lowercolumn -->
		</div> <!-- /outerframe -->
	</main>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="JS/index.js"></script>

	<!-- firebaseのコード（1） -->
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/8.6.3/firebase.js"></script>

	<!-- TODO: Add SDKs for Firebase products that you want to use
			     https://firebase.google.com/docs/web/setup#available-libraries -->
	<script src="https://www.gstatic.com/firebasejs/8.6.3/firebase-analytics.js"></script>
	<script>
		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		var firebaseConfig = {
			apiKey: "AIzaSyD64Pfvwwrz8uHGIEA5MQ5YythAxcWX-Ak",
			authDomain: "busshikanri-app.firebaseapp.com",
			projectId: "busshikanri-app",
			storageBucket: "busshikanri-app.appspot.com",
			messagingSenderId: "747011002435",
			appId: "1:747011002435:web:905b69422d438e3edc84f6",
			measurementId: "G-YQ7X825F8Q"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);
		firebase.analytics();
		var dbR = firebase.firestore().collection('report');
		var dbRc = firebase.firestore().collection('reportCenter');
		var dbRs = firebase.firestore().collection('reportSouth');
		var dbRn = firebase.firestore().collection('reportNorth');
		var dbS = firebase.firestore().collection('supply');
		var dbC = firebase.firestore().collection('chat');

		// 日時の表示
		function convertFromFirestoreTimestampToDatetime(timestamp) {
			const _d = timestamp ? new Date(timestamp * 1000) : new Date();
			const Y = _d.getFullYear();
			const m = (_d.getMonth() + 1).toString().padStart(2, '0');
			const d = _d.getDate().toString().padStart(2, '0');
			const H = _d.getHours().toString().padStart(2, '0');
			const i = _d.getMinutes().toString().padStart(2, '0');
			const s = _d.getSeconds().toString().padStart(2, '0');
			return `${Y}年${m}月${d}日 ${H}:${i}`;
		}

		// 避難状況の報告を受信
		dbR.orderBy('time', 'desc').onSnapshot(function (querySnapshot) {
			// console.log(querySnapshot.docs);
			const dataHinanArray = [];
			querySnapshot.docs.forEach(function (doc) {
				const dataHinan = {
					id: doc.id,
					data: doc.data(),
				};
				dataHinanArray.push(dataHinan);
			});
			// console.log(dataHinanArray);

			const tagHinanArray = [];
			dataHinanArray.forEach(function (data) {
				const tagSetai = `
					<li id="${data.id}">
						<span>■ ${convertFromFirestoreTimestampToDatetime(data.data.time.seconds)}</span>
						<p>【${data.data.kouku}校区】${data.data.staff}</p>
						<p>　避難世帯数：${data.data.setai}</p>
						<p>　避難者数：${data.data.evacuees}</p>
						<p>　要配慮者：${data.data.welfare}</p>
						<p>　備考：${data.data.memo}</p>
					</li>
					`;
				tagHinanArray.push(tagHinan);
			})

			$('#outputHinan').html(tagHinanArray);
		});

		// 物資の使用記録を受信
		dbS.orderBy('time', 'desc').onSnapshot(function (querySnapshot) {
			console.log(querySnapshot.docs);
			const dataBusshiArray = [];
			querySnapshot.docs.forEach(function (doc) {
				const dataBusshi = {
					id: doc.id,
					data: doc.data(),
				};
				dataBusshiArray.push(dataBusshi);
			});
			console.log(dataBusshiArray);
			const tagBusshiArray = [];
			dataBusshiArray.forEach(function (data) {
				const tagBusshi = `
	<li id="${data.id}"><a href="#">
		<p>【${data.data.kouku}】${data.data.staff}　
			<span>■ ${convertFromFirestoreTimestampToDatetime(data.data.time.seconds)}</span><br>
		　アルファ米：${data.data.kome} / 缶詰：${data.data.can} / 水：${data.data.water} / ビア：${data.data.beer} / 乾電池：${data.data.battery}<br>
		　粉ミルク：${data.data.milk} / おむつ：${data.data.omutsu} / 毛布：${data.data.blanket} / マット：${data.data.mat}<br>
		　その他：${data.data.text}</p>
	</a></li>
	`;
				tagBusshiArray.push(tagBusshi);
			})
			$('#outputBusshi').html(tagBusshiArray);
		});

		// チャットを送受信
		$('#sendChat').on('click', function () {
			const dataChat = {
				kouku: $('#koukuChat').val(),
				staff: $('#staffChat').val(),
				chat: $('#chat').val(),
				time: firebase.firestore.FieldValue.serverTimestamp(),
			};
			// console.log(dataChat);
			dbC.add(dataChat);
			$('#chat').val('');
		});

		dbC.orderBy('time', 'desc').onSnapshot(function (querySnapshot) {
			// console.log(querySnapshot.docs);
			const dataChatArray = [];
			querySnapshot.docs.forEach(function (doc) {
				const dataChat = {
					id: doc.id,
					data: doc.data(),
				};
				dataChatArray.push(dataChat);
			});
			// console.log(dataChatArray);

			const tagChatArray = [];
			dataChatArray.forEach(function (data) {
				const tagChat = `
	<div class="onebox">
		<div class="fukiArea">
			<div class="fukidasi">
				<li id="${data.id}">
					<p>■ ${convertFromFirestoreTimestampToDatetime(data.data.time.seconds)}</p>
					<p>【${data.data.kouku}校区】${data.data.staff}</p>
					<p>　${data.data.chat}</p>
				</li>
			</div>
		</div>
	</div>
	`;
				tagChatArray.push(tagChat);
			})
			$('#outputChat').html(tagChatArray);
		});

	</script>

</body>

</html>